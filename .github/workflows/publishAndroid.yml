name: Publish Android Only

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version Name'
        required: true
      build:
        description: 'Build Number'
        required: true

jobs:
  release-android:
    name: Build and release Android app
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - uses: maxim-lobanov/setup-xamarin@v1
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1.2'
          bundler-cache: true
          
      - id: create_google_json
        env:
          TMPDIR: ${{ runner.temp }}
          GOOGLE_JSON_KEY_BASE64: ${{ secrets.GOOGLE_JSON_KEY_BASE64 }}
        run: |
          echo ${{ env.GOOGLE_JSON_KEY_BASE64 }} | base64 -d > "${{ env.TMPDIR }}/__google_credentials.json"
          echo ::set-output name=google_credentials_file::${{ env.TMPDIR }}/__google_credentials.json

      - id: create_key_store
        env:
          TMPDIR: ${{ runner.temp }}
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo ${{ env.ANDROID_KEYSTORE_BASE64 }} | base64 -d > "${{ env.TMPDIR }}/__keystore.jks"
          echo ::set-output name=keystore_file::${{ env.TMPDIR }}/__keystore.jks

      - name: Install Fastlane
        run: bundle install

      - name: Assemble and Upload to PlayStore
        run: bundle exec fastlane android build
        env:
          VERSION_NAME: ${{ github.event.inputs.version }}
          BUILD_NUMBER: ${{ github.event.inputs.build }}
          GOOGLE_JSON_FILE: ${{ steps.create_google_json.google_credentials_file }}
          ANDROID_KEYSTORE: ${{ steps.create_key_store.keystore_file }}
          STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}